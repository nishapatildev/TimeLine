/* *************************************************************************** */  
const errModule 			= require('../../../Utils/error');
const xmlParsing            = require('../../../Utils/xmlParsing')
const utils                 = require('../ATYATI/utils')
/* *************************************************************************** */  

/* *************************************************************************** */  
module.exports.frameMessage =  function frameMessage (transXpedia) {
	return new Promise ((resolved, rejected) => {
		try {
			let request = '';
            request += '00000000000000000';
            request += '00000000000000000';
            request += ( (transXpedia.clientData.custtype || '') + '  ' ).slice(0,2);
            request += ( (transXpedia.clientData.custtittle || '') + '  ').slice(0,2);
            request += ( (transXpedia.clientData.custname || '') + '                                        ' ).slice(0,40);
            request += ( (transXpedia.clientData.custlastname || '') + '                                        ' ).slice(0,40);
            request += ( (transXpedia.clientData.relationshipname || '') + '                                        ' ).slice(0,40);
            request += ( (transXpedia.clientData.relationshiptype || '') + ' ' ).slice(0,1);
            request += ( (transXpedia.clientData.cusrmartialstatus || '') + ' ' ).slice(0,1);
            request += ( (transXpedia.clientData.custdob || '') + '        ' ).slice(0,8);        
            request += ( (transXpedia.clientData.custsex || '') + ' ' ).slice(0,1);
            request += ( (transXpedia.clientData.custplaceofbirth || '') + '                              ' ).slice(0,30); 
            request += ( (transXpedia.clientData.custnationality || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custlanguagecode || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custform60or61 || '') + '          ').slice(0,10); 
            request += ( (transXpedia.clientData.custaddress1 || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.custaddress2 || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.custaddress3 || '') + '                                        ').slice(0,40); 
            request += ( (transXpedia.clientData.custpresentlandmark || '') + '                                        ').slice(0,40); 
            request += ( (transXpedia.clientData.custcountry || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custstatecode || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custcitycode || '') + '  ' ).slice(0,3); 
            request += ( (transXpedia.clientData.custdistrict || '') + '   ' ).slice(0,3); 
            request += ( (transXpedia.clientData.custsubdist || '') + '     ' ).slice(0,5); 
            request += ( (transXpedia.clientData.custvillage || '') + '      '  ).slice(0,6); 
            request += ( (transXpedia.clientData.custpinnumber || '') + '      '  ).slice(0,6); 
            request += ( (transXpedia.clientData.custpermaddress1 || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.custpermaddress2 || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.custpermaddress3 || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.custpermlandmark || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.permcountry || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custpermstatecode || '') + '  ').slice(0,2); 
            request += ( (transXpedia.clientData.custpermcitycode || '') + '  ' ).slice(0,3); 
            request += ( (transXpedia.clientData.custpermdistrict || '') + '   ' ).slice(0,3); 
            request += ( (transXpedia.clientData.custpermsubdist || '') + '     ').slice(0,5); 
            request += ( (transXpedia.clientData.custpermvillage || '') + '      ' ).slice(0,6); 
            request += ( (transXpedia.clientData.custpermpincode || '') + '      ' ).slice(0,6); 


            request += ( (transXpedia.clientData.addressproofdoctype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.addressproofdocnumber || '') + '                    ' ).slice(0,20); 
            request += ( (transXpedia.clientData.addrissuedby || '') + '                    ' ).slice(0,20); 
            request += ( (transXpedia.clientData.addrissueplace || '') + '                              ' ).slice(0,30); 
            request += ( (transXpedia.clientData.addrissuedate || '') + '        ' ).slice(0,8); 

            request += ( (transXpedia.clientData.identitydoctype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.identitydocnumber || '') + '                    ').slice(0,20); 
            request += ( (transXpedia.clientData.idissuedby || '') + '                    ' ).slice(0,20); 
            request += ( (transXpedia.clientData.idissueplace || '') + '                              ' ).slice(0,30); 
            request += ( (transXpedia.clientData.idissuedate || '') + '        ' ).slice(0,8); 
            request += ( (transXpedia.clientData.custcommunitycode || '') + '      ' ).slice(0,6); 
            request += ( (transXpedia.clientData.custoccupation || '') + '    ' ).slice(0,4);
            request += ( (transXpedia.clientData.lineofbusiness || '') + '  ' ).slice(0,2);
            request += ( (transXpedia.clientData.custemployertype || '') + '  ' ).slice(0,2);
            request += ( (transXpedia.clientData.educationalqualification || '') + '  ' ).slice(0,2);
            request += ( (transXpedia.clientData.grossannualincome || '') + '  ' ).slice(0,2);
            request += ( (transXpedia.clientData.sourceannualincome || '') + '  ' ).slice(0,2);

            request += ( (transXpedia.clientData.custvehicletype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custhousetype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.ownshares || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.ownmutualfund || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.owngold || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.ownbankfixeddeposit || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.ownnsckvc || '') + ' ').slice(0,1); 
            request += ( (transXpedia.clientData.ownppf || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.ownrbibond || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.ownproperty || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.others || '') + ' ').slice(0,1);

            request += ( (transXpedia.clientData.carloan || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.housingloan || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.consumerloan || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.educationalloan || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.businessagricultureloan || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.custresidenceperiod || '') + '  ' ).slice(0,2); 
            request += ( '00000000000000' + transXpedia.clientData.custnetworth || '').slice(0,14); 
            request += ( (transXpedia.clientData.incomerecptmode || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.txnpaidlast2years || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custannualexpectedcredit || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.risktype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.politicallyexposed || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.custpancardpresense || '') + ' ' ).slice(0,1); 
            request += 'Y'; 
            request += ( (transXpedia.clientData.ciscode || '') + '   ' ).slice(0,3); 
            request += ( (transXpedia.clientData.bsrcode || '') + '   ' ).slice(0,3); 
            request += ( (transXpedia.clientData.domesticrisk || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.crossborderrisk || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.countryofrisk || '') + '  ').slice(0,2); 
            request += ( (transXpedia.clientData.segmentcode || '') + '    ').slice(0,4); 
            request += ( (transXpedia.clientData.domicile || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.custresidentstatus || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.customerevaluationrequired || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.mobilecountrycode || '') + '     ' ).slice(0,5); 
            request += ( (transXpedia.clientData.custmobilenumber || '') + '            ' ).slice(0,12); 
            request += ( (transXpedia.clientData.custemailid || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.mobileflag || 'A') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.uidflag || 'A') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.custaadhaarno || '') + '            ' ).slice(0,12); 
            request += ( (transXpedia.clientData.fspref || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.fsfname || '') + '                                                  ' ).slice(0,50); 
            request += ( (transXpedia.clientData.fsflastname || '') + '                                                  ' ).slice(0,50); 
            request += ( (transXpedia.clientData.cpoaddtype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.claddtype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.tempdocname || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.tempdocno || '') + '                    ' ).slice(0,20); 
            request += ( (transXpedia.clientData.tempdocissueby || '') + '                    ' ).slice(0,20); 
            request += ( (transXpedia.clientData.tempdocissueplace || '') + '                              ' ).slice(0,30); 
            request += ( (transXpedia.clientData.tempdocissuedate || '') + '        ' ).slice(0,8); 
            request += ( (transXpedia.clientData.addinjursameas || '') + '  ').slice(0,2); 
            request += ( (transXpedia.clientData.idexpirydate || '') + '        ' ).slice(0,8); 
            request += ( (transXpedia.clientData.mothertitle || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.motherfirstname || '') + '                                                  ' ).slice(0,50); 
            request += ( (transXpedia.clientData.motherlastname || '') + '                                                  ' ).slice(0,50); 
            request += ( '00000' + transXpedia.clientData.branch || '').slice(0,5); 
            request += ( (transXpedia.clientData.nomregflag || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.nomineetitlecode || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.nomineename || '') + '                              ' ).slice(0,30); 
            request += ( (transXpedia.clientData.nomineeage || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.nomineeaddress || '') + '                              ' ).slice(0,30); 
            request += ( '00' + (transXpedia.clientData.nomineerelation || '') ).slice(0,2); 
            request += ( (transXpedia.clientData.nomineeminor || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.nomineedob || '') + '        ' ).slice(0,8); 
            request += ( (transXpedia.clientData.guardianname || '') + (transXpedia.clientData.guardianaddress1 || '') + '                                        ' ).slice(0,40); 
            request += ( (transXpedia.clientData.npmr || '') + '   ' ).slice(0,3); 
            request += ( (transXpedia.clientData.printflag || 'N') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.identitydocnumber || '') + '              ').slice(0,14); 
            request += ( (transXpedia.clientData.identitydoctype || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.atmfacilityrequired || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.custnationality || '') + '   ' ).slice(0,3); 
            request += ( (transXpedia.clientData.atmfacilityrequired || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.accsubtype || '') + '    ' ).slice(0,4); 
            request += ( (transXpedia.clientData.intcat || '') + '    ' ).slice(0,4); 
            request += ( (transXpedia.clientData.intcode || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.custlanguagecode || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.stmtfrequency || '') + ' ').slice(0,1); 
            request += ( (transXpedia.clientData.stmtdate || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.mailid || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.noticeind || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.stmtcycle || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.stmtday || '') + '  ' ).slice(0,2); 
            request += ( (transXpedia.clientData.noticeprocind || '  ') + ' ' ).slice(0,2); 
            request += ( (transXpedia.clientData.acctsgmtcode || '') + '    ' ).slice(0,4); 
            request += ( (transXpedia.clientData.smsrequired || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.creditthreshold || '') + '              ' ).slice(0,14); 
            request += ( (transXpedia.clientData.debitthreshold || '') + '              ' ).slice(0,14); 
            request += ( (transXpedia.clientData.savpind || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.modind || '') + ' ').slice(0,1); 
            request += ( (transXpedia.clientData.lifofifoind || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.uidtoken || '') + '                                                                        ').slice(0,72); 
            request += 'T'; 
            request += '  '; 
            request += '            '; 
            request += '        '; 
            request += ( (transXpedia.clientData.debitflag || '') + ' ' ).slice(0,1); 
            request += ( (transXpedia.clientData.factcaflag || '') + ' ' ).slice(0,1); 
           
			transXpedia.requestBuffer = Buffer.from(request);
			this.emit('tocbs',request);
			return resolved(transXpedia);
		} catch (e) {
			transXpedia.errorData.systemErr   	= e;
			transXpedia.errorData.serverError 	= errModule.E_GATEWAY_MESSAGE_FRAMING;
			return rejected(transXpedia);
		}
	});
};

module.exports.extractMessage = function extractMessage (transXpedia) {
	return new Promise ((resolved, rejected) => {
		try {
            
			this.emit('fromgateway', transXpedia.responseBuffer);

			transXpedia.responseData.gatewayResponseCode	= transXpedia.responseBuffer ? transXpedia.responseBuffer.slice(0,4) : '2000';
			transXpedia.responseData.gatewayResponseMsg 	= transXpedia.responseBuffer ? transXpedia.responseBuffer.slice(38) : 'Invalid Response From CBS/Gateway';
        
            if(transXpedia.responseData.gatewayResponseCode == '0000') {
                transXpedia.responseData.gatewayResponseCode    = '00';
                transXpedia.responseData.customerId		        = transXpedia.responseBuffer.slice(4,21);
                transXpedia.responseData.accountNo 		        = transXpedia.responseBuffer.slice(22,38);
                transXpedia.responseData.cbsStatusMsg 		    = transXpedia.responseBuffer.slice(38);
            }
                  
            return resolved(transXpedia);

		} catch (e) {
			transXpedia.errorData.systemErr   	= e;
			transXpedia.errorData.serverError 	= errModule.E_GATEWAY_MESSAGE_DE_FRAMING;
			return rejected(transXpedia);
		}
	});
};

/* *************************************************************************** */  
