# @ims/gateway-hub  
## Installation
--- 

This is a [Node.js](https://nodejs.org/en/) module available through the
[private npm registry]().

Before installing, [download and install Node.js](https://nodejs.org/en/download/).
Node.js 8.16 or higher is required.


Installation is done using the
[`npm install` command](https://docs.npmjs.com/getting-started/installing-npm-packages-locally):

```console
$ npm install @ims/gateway-hub --registry [url]
```
## Documentation
---
- Supported Gateways
    - [APS](#aps)
      - class methods
        - creditCardPreInsurance
    - [ATYATI](#atyati)
      - class methods
        - generateOtp
        - eKYC2_5
    - [CBI](#cbi)
      - class methods
        - acctAndCifCreation
        - signUpload
    - [MMI](#mmi)
      - class methods
        - getAuthToken
        - getRevGeoCode
- [TransXpedia](#transxpedia) 
    - [clientData](#clientdata)
    - [requestData](#requestdata)
    - [responseData](#responsedata)
    - [errorData](#errordata) 
---
## How To Use
---
- Every gateway exposed a set of class methods for doing that gateway specific calls.
- Every class methods excepts an option which includes the data required by that gateway for that call.
- TransXpedia is an object returned to the caller as a response which includes four major object i.e clientData, requestData, responseData and errorData.
- If class method resolved to a value, means we received either success or failure response from the gateway.
- If class methods rejected means we didn't received a response from gateway or may be some internal error happened inside the module.
- Logs of gateway request and response will be send to the caller in an event callback as a string, which can be parsed based on the string type json/xml. 
--- 
## Supported Gateway
---  
## `APS`  
- *Gateway for uploading bkyc related data by Hdfc Bank.*  
- *Supports http and https protocol for communication.* 
  
```js
const Gateway = require("@ims/gateway-hub").Gateway;

const attr = {
	name : "APS",
    debug: 0
}

const Aps = new Gateway(attr);

Aps.on('togateway',(data)=>{
    //to gateway request data - transxpedia.requestData
})


Aps.on('fromgateway',(data)=>{
   //from gateway response data - transxpedia.responseData
})
  ```
### **class methods**  
1. #### creditCardPreInsurance([option: schema](./Gateways/APS/ajvSchemas.js "Please check schema"))


```js
const option = {
    requestNumber: "123412341234",
    applicationRefNo: "1234123412341234", 
    base64encodedDocument: "xfewewgewgew==", 
    advReferenceNumber: "1234567890",
    rrn: "123412341234",
    consentDate: "20220508134530", //YYYYMMDDHHMMSS
    consentFlag: "Y",
    consentLanguage: "ENGLISH",
    consentVersion: "1.0.0",
    gatewayUrl: "http://127.0.0.1:4343/creditCardPreInsurance",
    gatewayTimeout: 60,
    gatewayCaCertificate: "" ,
    key: "" ,
    cert: ""
}

Aps.creditCardPreInsurance(option)
.then((transXpedia)=>{ 
  // handle gateway response either error or success
    // transXpedia.responseData.gatewayResponseCode = "0000";
    // transXpedia.responseData.gatewayResponseMsg = "success";
})
.catch((transXpedia)=>{
    // handle error - transXpedia.errorData"
})
```
## `ATYATI`  
- *Atyati is providing ekyc calls.*  
- *Supports http and https protocol for communication.* 
  
```js
const Gateway = require("@ims/gateway-hub").Gateway;

const attr = {
	name : "ATYATI",
    debug: 0
}

const Atyati = new Gateway(attr);

Atyati.on('togateway',(data)=>{
    //to gateway request data - transxpedia.requestData
})


Atyati.on('fromgateway',(data)=>{
   //from gateway response data - transxpedia.responseData
})
  ```
### **class methods**  
1. #### generateOtp([option: schema](./Gateways/ATYATI/ajvSchemas.js "Please check schema"))


```js
const option = {
    tid: "123412341234",
    channel: "1234123412341234", 
    uid: "xfewewgewgew==", 
    cbsTerminalId: "1234567890",
    consent: "i declare",
    caTid: "20220508134530", 
    agentName: "amit",
    agentAddress: "nagenahalli gate",
    agentCity: "bangalore",
    agentState: "KA",
    bankCode: "PNB",
    mcc: "6012",
    posCode: "10",
    posEntryMode: "019",
    gatewayUrl: "http://127.0.0.1:4343/creditCardPreInsurance",
    gatewayTimeout: 60,
    gatewayCaCertificate: "" ,
    key: "" ,
    cert: "",
}

Atyati.generateOtp(option)
.then((transXpedia)=>{ 
    // handle gateway response either error or success
    // transXpedia.responseData.gatewayResponseCode
		// transXpedia.responseData.gatewayResponseMsg 
		// transXpedia.responseData.communicationId
    // transXpedia.responseData.uidType
    // transXpedia.responseData.uidaiAuthCode 
    // transXpedia.responseData.txn 
})
.catch((transXpedia)=>{
    // handle error - transXpedia.errorData"
})
```
2. #### eKYC2_5([option: schema](./Gateways/ATYATI/ajvSchemas.js "Please check schema"))


```js
const option = {
    transactionInfo: {
        agentName: "amit"
        agentAddress: "nagenahalli gate",
        agentCity: "bangalore",
        agentState: "KA",
        bankCode: "PNB",
        mcc: "6012",
        posCode: "10",
        posEntryMode: "019", 
        cbsTerminalId: "12341234443"
        pfr: "Y"
      },
    rdInfo: {
        uses: {
            pi: "n",
            pa: "n",
            pfa: "n",
            bio: "Y",
            bt: "FMR,FIR",
            pin: "n",
            otp: "n"
          },
        meta: {
            udc: "IMSPL30052012A05399",
            dpId: "STARTEK.ACPL",
            rdsId: "ACPL.WIN.001",
            rdsVer: "1.0.1",
            dc: "33627fc8-46fb-4a86-baf9-c902909a1fef",
            mi: "FM220U",
            mc: "MIIDgjCCAmqgAwI",
            error: "",
          },
        skey: {
            ci: "20150805",
            encodedSk: "ENCODED SKEY"
          },
        data: {
            type: "P",
            encodedValue: "ENCODED PID" 
          },
        additional_info: {
            srNo: "B46925818",
            deviceType: "Secure", 
            supportUpto: "15-Sep-2018",
          },
        encodedHmac: "ENCODED HMAC",
        rc: "Y",
        ra: "F",
        fType: 2, 
        iCount: 0,
        pCount: 0,
        errCode: 0,
        errInfo: "",
        fCount: 1,
        ts: "2017-09-15T18:31:21",
        nmPoints: 23, 
        qScore: 80,
        lot: "P",
        lov: "828121",
      },
    gatewayUrl: "http://127.0.0.1:4343/creditCardPreInsurance",
    gatewayTimeout: 60,
    gatewayCaCertificate: "" ,
    key: "" ,
    cert: ""
}

Atyati.eKYC2_5(option)
.then((transXpedia)=>{ 
    // handle gateway response either error or success
  	// transXpedia.responseData.gatewayResponseCode	
		// transXpedia.responseData.gatewayResponseMsg 
 		// transXpedia.responseData.ekycData            
    // transXpedia.responseData.communicationId	
    // transXpedia.responseData.uidType 
    // transXpedia.responseData.uidToken 
    // transXpedia.responseData.uidaiAuthCode 
    // transXpedia.responseData.txn 
    // transXpedia.responseData.gatewayRrn 
})
.catch((transXpedia)=>{
    // handle error - transXpedia.errorData"
})
```
## `MMI`  
- *Map my india gateway by hdfc bank for getting location details.*  
- *Supports http and https protocol for communication.* 
  
```js
const Gateway = require("@ims/gateway-hub").Gateway;

const attr = {
	name : "MMI",
    debug: 0
}

const Mmi = new Gateway(attr);

Mmi.on('togateway',(data)=>{
    //to gateway request data - transxpedia.requestData
})


Mmi.on('fromgateway',(data)=>{
   //from gateway response data as xml string- transxpedia.responseData
})
  ```
### **class methods**  
1. #### getAuthToken([option: schema](./Gateways/MMI/ajvSchemas.js "Please check schema"))


```js
const option = {
    transactionId : "1234567890",
	clientId : 'ueruerueruer',
	clientSecret : 'serserserser',
	channelId : '23',
	userId : 'amit',
	bankCode : 'bvc',
	transactionBranch : '12344321',
    gatewayUrl: "http://127.0.0.1:4343/creditCardPreInsurance",
    gatewayTimeout: 60,
    gatewayCaCertificate: "" ,
    key: "" ,
    cert: "",
}

Mmi.getAuthToken(option)
.then((transXpedia)=>{ 
    // handle gateway response either error or success
    // transXpedia.responseData.gatewayResponseCode 
    // transXpedia.responseData.gatewayResponseMsg 
    // transXpedia.responseData.gatewayRefId 
    // transXpedia.responseData.accessToken
})
.catch((transXpedia)=>{
    // handle error - transXpedia.errorData"
})
```
2. #### getRevGeoCode([option: schema](./Gateways/MMI/ajvSchemas.js "Please check schema"))


```js
const option = {
	gatewayUrl : 'http://127.0.0.1:20000/getRevGeoCode',
	gatewayTimeout: 30,
	transactionId : '1234567890',
	clientId : 'ueruerueruer',
	clientSecret : 'serserserser',
	channelId : '23',
	userId : 'amit',
	bankCode : 'bvc',
	transactionBranch : '12344321',
	accessToken : "token from first call",
	latitude : "26.5645",
	longitude : "29.5645",
	gatewayCaCertificate : '',
	key : '',
	cert : ''
}


Mmi.getRevGeoCode(option)
.then((transXpedia)=>{ 
    // handle gateway response either error or success
    // transXpedia.responseData.gatewayResponseCode 
    // transXpedia.responseData.gatewayResponseMsg 
    // transXpedia.responseData.gatewayRefId 
    // transXpedia.responseData.address
})
.catch((transXpedia)=>{
    // handle error - transXpedia.errorData"
})
```
---
## TransXpedia 
---
*Check class defination for keys information* ([Check Class Here](./Utils/transXpedia.js)).  

### `clientData`
- Object that holds client options
### `requestData`
- Object that holds gateway request
### `responseData`
- Object that holds gateway response along with some metadata

```js
    this.responseData.gatewayResponse = null; // gateway response full data
    this.responseData.gatewayResponseCode = null; //gateway response code
    this.responseData.gatewayResponseMsg = null; //gateway response message
    this.responseData.gatewayConnTime = null; //metadata
    this.responseData.gatewayRespBackTime = null; //metadata
    this.responseData.gatewaySendTime = null; //metadata
```
### `errorData`
- Object that holds module errors like gateway connection error, no data received from gateway, gateway timeout etc.
```js
    this.errorData.serverError = {};
    this.errorData.serverError.errorCode = null; // module error code
    this.errorData.serverError.errString = null; // module error message
    this.errorData.systemErr = null; // detailed error for system exceptions if any
    this.errorData.errDescription = null; // error description for debugging
```

